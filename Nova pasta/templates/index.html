<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Lavanderia Flat Horizonte Hotel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <div class="auth-buttons">
            <button class="btn-auth btn-criar" onclick="window.location.href='#'">Criar Conta</button>
            <button class="btn-auth btn-acessar" onclick="window.location.href='#'">Acessar Conta</button>
        </div>
        <div class="imagem-centralizada">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='logo hotel.jpg') }}" alt="Logo do Hotel" width="200" />
            </a>
        </div>
        
        <div class="header-navigation">
            <nav class="navbar-principal">
               <ul>
                  <li><a href="{{ url_for('index') }}" class="active">Lavanderia</a></li>
                  <li><a href="{{ url_for('entregas') }}">Entregas</a></li>
               </ul>
            </nav>
        </div>


    </header>

    <main>

        <div id="menu">
            <button class="botao" onclick="mostrar('consultar')">Cadastrar/Consultar Hor√°rio</button>
            <button class="botao" onclick="mostrar('desmarcar')">Desmarcar Hor√°rio</button>
        </div>

        <div id="secoes-funcionais">
            <!-- CONSULTAR / AGENDAR -->
            <section id="consultar" style="display:block;">
                <div id="modal">
                    <div id="modal-content">
                        <button id="modal-close" onclick="fecharModal()">&times;</button>
                        <button id="modal-prev" onclick="imagemAnterior()" style="display:none;">&#8592;</button>
                        <img id="modal-img" src="" alt="Imagem ampliada" style="display:none;" />
                        <button id="modal-next" onclick="proximaImagem()" style="display:none;">&#8594;</button>
                        <div id="modal-message" style="display:none;"></div>
                    </div>
                </div>

                <div class="agendamento-form">
                    <h2>Agendar Lavanderia</h2>
                    <label for="nome-agendamento">Nome:</label>
                    <input type="text" id="nome-agendamento" placeholder="Digite o nome" required>
                    <label for="apto-agendamento">Apartamento:</label>
                    <input type="text" id="apto-agendamento" placeholder="Ex: 203" required>

                    <div class="horarios-container">
                        <h4>Hor√°rios dispon√≠veis</h4>
                        <div id="horarios-disponiveis" class="horarios-grid"></div>
                    </div>

                    <button id="confirmar-agendamento" class="botao" onclick="confirmarAgendamento()">Confirmar Agendamento</button>
                </div>
                
                <div class="secao-busca">
                    <div class="consulta-header">
                        <h3>Consultar Agendamentos</h3>
                        <div class="data-selector">
                            <label for="data-consulta">Selecionar Data:</label>
                            <input type="date" id="data-consulta" onchange="consultarAgendamentosPorData()">
                            <button class="botao" onclick="consultarTodosAgendamentos()">Ver Todos</button>
                        </div>
                    </div>

                    <div class="agendamentos-grid" id="agendamentos-grid">
                        <div class="grid-header">
                            <div class="grid-cell header">Hor√°rio</div>
                            <div class="grid-cell header">Pessoa 1</div>
                            <div class="grid-cell header">Pessoa 2</div>
                            <div class="grid-cell header">Status</div>
                        </div>
                        <div id="grid-content">
                            <!-- Conte√∫do ser√° preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Tabela tradicional para "Ver Todos" -->
                    <div class="tabela-container" id="tabela-tradicional" style="display:none;">
                        <table id="resultadoConsulta">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Apto</th>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="calendario-container">
                    <div class="calendario-header">
                        <button onclick="mesAnterior()">&#8592;</button>
                        <div id="mes-ano" style="font-weight:bold;"></div>
                        <button onclick="proximoMes()">&#8594;</button>
                    </div>
                    <div id="calendario"></div>
                </div>
            </section>

            <!-- DESMARCAR FORM -->
            <section id="desmarcar" style="display:none;">
                <h2>Desmarcar Cliente</h2>
                <form action="/desmarcar" method="post">
                    <p>
                        <label for="nome-desmarcar">Nome do Cliente</label>
                        <input type="text" id="nome-desmarcar" name="nome" required />
                    </p>
                    <p>
                        <label for="apto-desmarcar">Apartamento</label>
                        <input type="number" id="apto-desmarcar" name="apto" required />
                    </p>

                    <button class="botao" type="submit">Desmarcar</button>
                </form>
            </section>
        </div>

        <div class="hotel-container">
            <div class="hotel-info">
                <h1>Nossa Lavanderia</h1>
                <p>Conhe√ßa nossa estrutura moderna e equipamentos de alta qualidade para melhor atender nossos h√≥spedes.</p>
            </div>
            <div class="imagens">
                <div><img src="{{ url_for('static', filename='lavanderia2.jpg') }}" alt="Lavanderia 2" onclick="mostrarImagem(this.src)" /></div>
                <div><img src="{{ url_for('static', filename='lavanderia3.jpg') }}" alt="Lavanderia 3" onclick="mostrarImagem(this.src)" /></div>
                <div><img src="{{ url_for('static', filename='laavnderia4.jpg') }}" alt="Lavanderia 4" onclick="mostrarImagem(this.src)" /></div>
            </div>
        </div>
    </main>

   <script>
        // Troca de se√ß√µes
        function mostrar(secao) {
            document.querySelectorAll("#secoes-funcionais section").forEach(s => s.style.display = "none");
            const ativa = document.getElementById(secao);
            if (ativa) {
                ativa.style.display = "block";
                if (secao === "consultar") {
                    atualizarCalendario();
                    buscarClientes();
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            mostrar('consultar');
            
            // Inicializa o calend√°rio
            const hoje = new Date();
            diaSelecionado = hoje;
            atualizarCalendario();
            selecionarDia(hoje.getDate(), hoje.getMonth(), hoje.getFullYear());
            
            // Define a data de hoje no campo de consulta e carrega agendamentos
            inicializarDataHoje();
        });

        // Fun√ß√£o para definir a data de hoje e carregar agendamentos automaticamente
        function inicializarDataHoje() {
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            
            const dataInput = document.getElementById('data-consulta');
            if (dataInput) {
                dataInput.value = dataFormatada;
                // Carrega automaticamente os agendamentos de hoje
                consultarAgendamentosPorData();
            }
        }

        // Consulta de clientes
        async function buscarClientes() {
            const nomeBusca = document.getElementById('buscaCliente') ? document.getElementById('buscaCliente').value : '';
            const res = await fetch(`/consultar?nome=${encodeURIComponent(nomeBusca)}`);
            const clientes = await res.json();
            const tbody = document.querySelector('#resultadoConsulta tbody');
            
            if (tbody) {
                tbody.innerHTML = '';
                clientes.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Nome">${c.nome}</td>
                        <td data-label="Apto">${c.apto}</td>
                        <td data-label="Data">${c.data}</td>
                        <td data-label="Hor√°rio">${c.horario}</td>
                        <td><button class="botao-excluir" onclick="desmarcarCliente('${c.nome}','${c.apto}','${c.data}','${c.horario}')">üóëÔ∏è</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // Desmarcar cliente via bot√£o individual
        async function desmarcarCliente(nome, apto, data, horario) {
            if (!confirm(`üóëÔ∏è REMOVER AGENDAMENTO\n\nPessoa: ${nome}\nApartamento: ${apto}\nData: ${data}\nHor√°rio: ${horario}\n\nDeseja confirmar a remo√ß√£o?`)) {
                return;
            }
            
            try {
                const res = await fetch("/desmarcar_horario", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams({ nome, apto, data, horario })
                });
                
                const resp = await res.json();
                
                if (resp.erro) {
                    alert(`‚ùå Erro: ${resp.erro}`);
                } else {
                    alert(`‚úÖ Agendamento de ${nome} (${apto}) removido com sucesso!`);
                    
                    // Atualiza automaticamente as visualiza√ß√µes
                    await atualizarVisualizacoes();
                }
            } catch (error) {
                console.error('Erro ao desmarcar:', error);
                alert('‚ùå Erro ao desmarcar agendamento');
            }
        }

        // --- Calend√°rio e agendamento ---
        let dataAtual = new Date(), diaSelecionado = null;

        function atualizarCalendario() {
            const mesAno = document.getElementById("mes-ano"),
                calendario = document.getElementById("calendario"),
                mes = dataAtual.getMonth(),
                ano = dataAtual.getFullYear();
            if (!mesAno || !calendario) return;
            mesAno.textContent = `${["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][mes]} ${ano}`;
            calendario.innerHTML = "";

            // Siglas dos dias da semana
            const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
            const diasSemanaDiv = document.createElement("div");
            diasSemanaDiv.className = "dias-semana";
            diasSemana.forEach(sigla => {
                const span = document.createElement("span");
                span.textContent = sigla;
                diasSemanaDiv.appendChild(span);
            });
            calendario.appendChild(diasSemanaDiv);

            // Dias do m√™s em linhas semanais
            const primeiroDia = new Date(ano, mes, 1);
            const ultimoDia = new Date(ano, mes + 1, 0);
            let grid = document.createElement("div");
            grid.className = "calendario-grid";
            for (let i = 0; i < primeiroDia.getDay(); i++) {
                const vazio = document.createElement("div");
                vazio.className = "dia vazio";
                grid.appendChild(vazio);
            }
            for (let i = 1; i <= ultimoDia.getDate(); i++) {
                const dia = document.createElement("div");
                dia.className = "dia";
                dia.textContent = i;
                const hoje = new Date();
                if (i === hoje.getDate() && mes === hoje.getMonth() && ano === hoje.getFullYear()) dia.classList.add("hoje");
                dia.onclick = () => selecionarDia(i, mes, ano);
                grid.appendChild(dia);
                // Nova linha a cada s√°bado ou √∫ltimo dia
                if ((primeiroDia.getDay() + i - 1) % 7 === 6 || i === ultimoDia.getDate()) {
                    calendario.appendChild(grid);
                    grid = document.createElement("div");
                    grid.className = "calendario-grid";
                }
            }
        }

        function mesAnterior() {
            dataAtual.setMonth(dataAtual.getMonth() - 1);
            atualizarCalendario();
        }

        function proximoMes() {
            dataAtual.setMonth(dataAtual.getMonth() + 1);
            atualizarCalendario();
        }

        function selecionarDia(dia, mes, ano) {
            document.querySelectorAll(".dia.selecionado").forEach(el => el.classList.remove("selecionado"));
            document.querySelectorAll(".dia").forEach(el => {
                if (parseInt(el.textContent) === dia) el.classList.add("selecionado");
            });
            diaSelecionado = new Date(ano, mes, dia);
            atualizarHorarios();
        }

        function atualizarHorarios() {
            const container = document.getElementById("horarios-disponiveis");
            if (!container || !diaSelecionado) return;
            container.innerHTML = "";
            const dataStr = diaSelecionado.toISOString().split("T")[0];
            fetch(`/horarios?data=${dataStr}`).then(res => res.json()).then(dados => {
                ["07:00", "10:00", "13:00", "16:00", "19:00", "22:00"].forEach(h => {
                    const div = document.createElement("div");
                    div.className = "horario-item";
                    div.textContent = h;
                    if (dados.ocupados.includes(h)) div.classList.add("ocupado");
                    else div.onclick = (e) => selecionarHorario(e);
                    container.appendChild(div);
                });
            });
        }

        function selecionarHorario(e) {
            document.querySelectorAll(".horario-item").forEach(el => el.classList.remove("selecionado"));
            e.target.classList.add("selecionado");
        }

        async function confirmarAgendamento() {
            if (!diaSelecionado) return alert("Selecione um dia!");
            
            const horarioSel = document.querySelector(".horario-item.selecionado");
            if (!horarioSel) return alert("Selecione um hor√°rio!");
            
            const nome = document.getElementById("nome-agendamento").value.trim();
            const apto = document.getElementById("apto-agendamento").value.trim();
            
            if (!nome || !apto) return alert("Preencha nome e apartamento!");
            
            const dataStr = diaSelecionado.toISOString().split("T")[0];
            
            try {
                const res = await fetch("/agendar", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ nome, apto, data: dataStr, horario: horarioSel.textContent })
                });
                
                const resp = await res.json();
                
                if (resp.erro) {
                    alert(resp.erro);
                } else {
                    alert("Agendamento confirmado!");
                    
                    // Limpa os campos do formul√°rio
                    document.getElementById("nome-agendamento").value = '';
                    document.getElementById("apto-agendamento").value = '';
                    
                    // Remove sele√ß√£o do hor√°rio
                    document.querySelectorAll(".horario-item").forEach(el => el.classList.remove("selecionado"));
                    
                    // Atualiza automaticamente as visualiza√ß√µes
                    await atualizarVisualizacoes();
                }
            } catch (error) {
                console.error('Erro ao agendar:', error);
                alert('Erro ao confirmar agendamento');
            }
        }

        // Modal de imagens
        const imagensModal = [
            "{{ url_for('static', filename='lavanderia1.jpg') }}",
            "{{ url_for('static', filename='lavanderia2.jpg') }}",
            "{{ url_for('static', filename='lavanderia3.jpg') }}",
            "{{ url_for('static', filename='laavnderia4.jpg') }}"
        ];
        let imagemAtual = 0;

        function mostrarImagem(src) {
            const modal = document.getElementById("modal");
            const img = document.getElementById("modal-img");
            const msg = document.getElementById("modal-message");
            const prev = document.getElementById("modal-prev");
            const next = document.getElementById("modal-next");
            imagemAtual = imagensModal.indexOf(src);
            img.src = src;
            img.style.display = "block";
            msg.style.display = "none";
            prev.style.display = "block";
            next.style.display = "block";
            modal.classList.add("ativo");
        }

        function proximaImagem() {
            imagemAtual = (imagemAtual + 1) % imagensModal.length;
            document.getElementById("modal-img").src = imagensModal[imagemAtual];
        }

        function imagemAnterior() {
            imagemAtual = (imagemAtual - 1 + imagensModal.length) % imagensModal.length;
            document.getElementById("modal-img").src = imagensModal[imagemAtual];
        }

        function fecharModal() {
            document.getElementById("modal").classList.remove("ativo");
        }

        // Fun√ß√£o para consultar agendamentos por data espec√≠fica
        async function consultarAgendamentosPorData() {
            const dataInput = document.getElementById('data-consulta');
            const dataSelecionada = dataInput.value;
            
            if (!dataSelecionada) {
                alert('Selecione uma data');
                return;
            }
            
            try {
                const res = await fetch(`/consultar?data=${dataSelecionada}`);
                const agendamentos = await res.json();
                
                mostrarGridAgendamentos(agendamentos, dataSelecionada);
                document.getElementById('agendamentos-grid').style.display = 'block';
                document.getElementById('tabela-tradicional').style.display = 'none';
            } catch (error) {
                console.error('Erro ao consultar agendamentos:', error);
            }
        }

        // Fun√ß√£o para mostrar todos os agendamentos na tabela tradicional
        async function consultarTodosAgendamentos() {
            document.getElementById('data-consulta').value = '';
            await buscarClientes();
            document.getElementById('agendamentos-grid').style.display = 'none';
            document.getElementById('tabela-tradicional').style.display = 'block';
        }

        // Fun√ß√£o para criar a grade de agendamentos com a√ß√µes individuais
        function mostrarGridAgendamentos(agendamentos, data) {
            const gridContent = document.getElementById('grid-content');
            const horarios = ["07:00", "10:00", "13:00", "16:00", "19:00", "22:00"];
            
            gridContent.innerHTML = '';
            
            horarios.forEach(horario => {
                const agendamentosHorario = agendamentos.filter(ag => ag.horario === horario);
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                // C√©lula do hor√°rio
                const cellHorario = document.createElement('div');
                cellHorario.className = 'grid-cell horario';
                cellHorario.textContent = horario;
                row.appendChild(cellHorario);
                
                // Pessoa 1
                const cellPessoa1 = document.createElement('div');
                cellPessoa1.className = 'grid-cell agendamento';
                if (agendamentosHorario[0]) {
                    cellPessoa1.innerHTML = `
                        <div class="agendamento-slot ocupado">
                            <div class="agendamento-info">
                                <div class="agendamento-nome">${agendamentosHorario[0].nome}</div>
                                <div class="agendamento-apto">Apto ${agendamentosHorario[0].apto}</div>
                            </div>
                            <button class="botao-excluir-individual" 
                                    onclick="desmarcarCliente('${agendamentosHorario[0].nome}','${agendamentosHorario[0].apto}','${agendamentosHorario[0].data}','${agendamentosHorario[0].horario}')"
                                    title="Remover ${agendamentosHorario[0].nome}">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                } else {
                    cellPessoa1.className += ' vazio';
                    cellPessoa1.innerHTML = `
                        <div class="agendamento-slot">
                            <span style="color: #999; font-style: italic;">Dispon√≠vel</span>
                        </div>
                    `;
                }
                row.appendChild(cellPessoa1);
                
                // Pessoa 2
                const cellPessoa2 = document.createElement('div');
                cellPessoa2.className = 'grid-cell agendamento';
                if (agendamentosHorario[1]) {
                    cellPessoa2.innerHTML = `
                        <div class="agendamento-slot ocupado">
                            <div class="agendamento-info">
                                <div class="agendamento-nome">${agendamentosHorario[1].nome}</div>
                                <div class="agendamento-apto">Apto ${agendamentosHorario[1].apto}</div>
                            </div>
                            <button class="botao-excluir-individual" 
                                    onclick="desmarcarCliente('${agendamentosHorario[1].nome}','${agendamentosHorario[1].apto}','${agendamentosHorario[1].data}','${agendamentosHorario[1].horario}')"
                                    title="Remover ${agendamentosHorario[1].nome}">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                } else {
                    cellPessoa2.className += ' vazio';
                    cellPessoa2.innerHTML = `
                        <div class="agendamento-slot">
                            <span style="color: #999; font-style: italic;">Dispon√≠vel</span>
                        </div>
                    `;
                }
                row.appendChild(cellPessoa2);
                
                // Coluna de status (substitui a coluna de a√ß√µes centralizadas)
                const cellStatus = document.createElement('div');
                cellStatus.className = 'grid-cell';
                const totalAgendamentos = agendamentosHorario.length;
                if (totalAgendamentos === 0) {
                    cellStatus.innerHTML = '<span style="color: #28a745; font-weight: 600;">Livre</span>';
                } else if (totalAgendamentos === 1) {
                    cellStatus.innerHTML = '<span style="color: #ffc107; font-weight: 600;">1 vaga</span>';
                } else {
                    cellStatus.innerHTML = '<span style="color: #dc3545; font-weight: 600;">Lotado</span>';
                }
                row.appendChild(cellStatus);
                
                gridContent.appendChild(row);
            });
        }

        // Fun√ß√£o para atualizar todas as visualiza√ß√µes ap√≥s mudan√ßas
        async function atualizarVisualizacoes() {
            // Atualiza os hor√°rios dispon√≠veis no calend√°rio
            if (diaSelecionado) {
                atualizarHorarios();
            }
            
            // Verifica qual visualiza√ß√£o est√° ativa na consulta
            const gridVisible = document.getElementById('agendamentos-grid').style.display !== 'none';
            const tabelaVisible = document.getElementById('tabela-tradicional').style.display !== 'none';
            
            if (gridVisible) {
                // Se a grade est√° vis√≠vel, recarrega os agendamentos da data selecionada
                const dataInput = document.getElementById('data-consulta');
                if (dataInput.value) {
                    await consultarAgendamentosPorData();
                }
            } else if (tabelaVisible) {
                // Se a tabela tradicional est√° vis√≠vel, recarrega todos os agendamentos
                await buscarClientes();
            } else {
                // Se nada est√° vis√≠vel, carrega a visualiza√ß√£o padr√£o (hoje)
                await inicializarDataHoje();
            }
        }
    </script>
</body>
</html>
